# 代码效用评定

### DQFileDownloader
经过整理发现，一个FileDownloader对应着一个下载单位，但是FileDownloader中原先的下载行为代码已经废弃无用，所以他并不是一个行为(网络请求、数据解析、复杂逻辑处理)类，而是一个下载单位的数据存储类。
因而相关的弃用下载代码都可以删除、整理，具体可删除代码内容标注在属性方法列表中。

#### 属性

 属性名 | 类型  | 访问权限 | 效用  | 补充
------ | -------| ----- |------ | -------
state | BZXFileDownloadState | read-write | 文件下载状态
url | NSURL   |readonly | 下载地址 | 作为FileDownloadManager中寻找FileDownloader的key值
filePath  | NSString  |  readonly | 保存文件路径
cachePath | NSString  |  readonly | 缓存路径 | 暂无有效调用
userAgent | NSString  |  readonly
cookie    | NSString  |  readonly
header   | NSDictionary | readonly | 请求头
progress | double |  readonly | 拓展方法，获取进度
isDownloading | BOOL   |  readonly | 拓展方法，判断是否下载中
hasFinished   | BOOL   |  readonly | 拓展方法，判断是否下载完成
fileSize     | long long | read-write |文件大小
finishedSize | long long | read-write |已完成的大小
cacheCapacity | long long | read-write |缓存大小 以M为单位 | 可删除
retryCount | NSInteger | read-write
connection | NSURLConnection | private | 下载连接 | 相关代码现已废弃，可以删整
delegate | id<BZXFileDownloaderDelegate> |read-write |回调函数 | 可以删除 |


#### 方法

方法名 | 调用关系(调用者) | 效用 | 补充 
-----|-------|------| -----
initWithURL: filePath:cachePath: cacheCapacity: | FileDownloadManager | 初始化，根据参数为只读属性赋初值 | 暂无调用（上级函数暂无调用）
initWithURL: filePath:cachePath: cacheCapacity:userAgent:cookie: | FileDownloadManager | 同上 | 暂无调用（上级函数暂无调用）
initWithURL: filePath:cachePath: cacheCapacity:header: | FileDownloadManager | 同上 | 目前实际调用方法
start | 无调用 |  - (void)start { return;} | 可以完全删除 
cancel | FileDownloadManager | 对state属性修改，并造成修改回调，其余代码无用 | 可删整
BZXFileDownloaderDidStarted: | 代理函数 | 修改state属性完成后进行回调，别无它用 | 可删整，对应删整代理实现FileDownloadManager类里的代码
BZXFileDownloaderDidDownloadData: | 代理函数 | 修改state后回调，同上 | 可删整 同上
BZXFileDownloaderDidChangeProgress: | 代理函数 | 修改state后回调，同上 | 可删整  同上
BZXFileDownloaderDidFinished: | 代理函数 | 修改state后回调，同上 | 可删整  同上
BZXFileDownloaderDidFailed: | 代理函数 | 修改state后回调，同上 | 可删整  同上
connectionDidFinishLoading: | 私有代理 NSURLConnectionDelegate | connectionq请求代理，已无用 | 可删除
connection: didReceiveData: | 同上 | | 可删除
connection: didReceiveResponse: | 同上 | | 可删除
creatConnection | 内部调用私有方法 | 创建connection，实际上已经无可用时机 | 可删除 
saveDataToFile |  内部调用私有方法 | 文件句柄操作，实际已经无效 | 可删除

#### 删整策略
**1. 属性和一些直观的方法**
这些内容不涉及文件之间的复杂讯息交互，可以直接连锁删除。
如connection属性，及其相关的所有函数。

**2. BZXFileDownloaderDelegate**

说明：1. BZXFileDownloaderDelegate 是FileDownloader声明的协议，FileDownloader持有者和协议方法代理者都是FileDownloadManager。2. 该代理的触发发生在FileDownloader的setState方法 以及NSURLConnectionDelegate回调中，如今后者已经废弃，再使用协议就再无必要，
> 1. 将FileDownloader中协议方法全部删除，包裹setState方法也没必要重写. 
> 2. FileDownloadManager中保留BZXFileDownloaderDelegate声明的方法实现，添加一个方法传参为FileDownloader和State，其中调用逻辑与FileDownloader.setState一致。当FileDownloadManager中调用fileDownloader更改state时候改为调用该方法，调用set方法时候示例代码如下：

```
- (void)fileDownloader:(BZXFileDownloader *)downloader changeState:(BZXFileDownloadState)state {
    downloader.state = state;
    switch (state) {
        case BZXFileDownloadState_Downloading: {
            [self BZXFileDownloaderDidStarted:downloader];
            break;
        }
            // 剩余代码，此处逻辑与FileDownloader.setState中逻辑保持一致。
    }
}
```

 
### FileDownloadManager，
处理VideoForDownload类发起的下载任务，并通过回调函数同步下载变化讯息；
执行下载任务并与下载单位关联管理（NSURLSessionDownloadTask <--> FileDownloader）；
> 结构上已经稳定，小部分版本遗留代码可以进行删除更改

#### 属性|成员变量
属性、变量名 | 类型 | 访问权限 | 效用  | 补充
-------|------ |----- |------ | -------
currentSession|NSURLSession | readonly |下载请求Session | 可以不暴露
resumeDatas | MuDictionary | private | 暂无使用到 | 可删除
downloadTasks | MuDictionary | private |  存放DownloadTask | 
notificationObservers|MuArray | private | 通知容器 | 
_fileFolderPath |NSString | private | 资源存储目录Document/DQFileDownloadCache | 
_cacheFolderPath| NSString|private | 缓存目录Document/DQFileDownloadTemp | 无实际效用，可删除，
_resumeDataFilePath |NSString| private | 断载缓存文件plist Document/DQFileDownloadTempresumeDatas.plist | 
_downloaders |MuArray | private | 存放FileDownloader | 便于索引寻去FileDownloader
_downloaderForURL |MuDictionary| private | 键值存放FileDownloader | 便于键值(url)寻找FileDownloader
_downloadDelegates| MuArray|private | 存放代理对象 | 代理协议 BZXFileDownloadManagerDelegate
_downloadURLs | MuArray | private | 暂无使用 | 可删除


#### 方法

方法名 | 调用关系(调用者) | 效用 | 补充 
-----|-------|------| -----
downloadFileWithURL: | VideoForDownload | 判断启动下载任务，并返回FileDownloader | 暂无调用
downloadFileWithURL: delegate: | VideoForDownload | 同上 | 暂无调用
downloadFileWithURL: delegate: userAgent: cookie:| VideoForDownload | 同上 | 暂无调用
downloaderWithDelegate: forURL: | VideoForDownload | 同上 | 暂无调用
downloadFileWithURL: delegate: header| VideoForDownload | 同上 | 现在实际使用方法
cancelForDelegate: | VideoForDwonload | 取消下载任务，移除相关对应代理 | 这个方法名字更改为cancelDownload更恰当
resumeTaskForDelegate:|VideoForDwonload | 恢复下载 | 暂无调用（上级函数暂无调用）
suspendTaskForDelegate:|VideoForDwonload | 暂停挂起下载任务 | 暂无调用（上级函数暂无调用）
deleteDownloadForURL: | VideoDownloadHelper、VideoForDwonload、self| 根据URL清除所有相关下载内容 |
saveResumeData: forURL:| VideoDownloadHelper self |保持下载缓存 |可以不必暴露（外部调用的代码其实已经无调用链延续）
deleteDownloadTempWithResumeData:|VideoDownloadHelper | 移除resumeData 对应的temp文件  | （外部调用的代码其实已经无调用链延续）可以考虑移除
filesMoveDir: toDir: | self | 文件目录转移 | 1.此功能可以封装在共有工具类，譬如Path中；2. 调用链版本已不存在，相关代码可以删除。
BZXFileDownloadManager: didStartedOfURL:downloader: | 协议代理函数| 同步下载状态变化讯息给VideoForDwonload 
BZXFileDownloadManager: didDownloadDataOfURL:downloader: | 同上| 同上 | 
BZXFileDownloadManager: didChangedProgressOfURL: downloader:| 同上| 同上 | 
BZXFileDownloadManager: didStartedOfURL: didFinishedOfURL: downloader:| 同上| 同上 | 
BZXFileDownloadManager: didStartedOfURL: didDidFaileOfURL: downloader:| 同上| 同上 | 
BZXFileDownloadManager: didStartedOfURL: didStopDownloadOfURL: downloader:| 同上| 同上 | 







### VideoForDownload
对应一个完整的视频下载对象

#### 方法
分组列出相关方法

##### 路径处理相关

  返回值  | 方法名 | 调用关系 | 效用  | 补充 
------|--------|------|-------|------|-----
NSString|filePathForUrl:|private|根据url生成完整的下载资源文件地址，Document/DQFileDownloadCache/[video folderPath]/[video videoFileNameForUrl:]
NSString|filePathAtIndex: | public | 根据索引生成完整的下载资源文件地址，Document/DQFileDownloadCache/[video folderPath]/[video videoFileNameAtIndex:] | 可以删除，用filePathForUrl:取代，统一代码。 
NSString|folderPath:|private|生成下载资源文件路径，Document/DQFileDownloadCache/[video folderPath]|
NSString|videoFileNameForUrl:|private|根据url生成视频文件名，[video.m3u8UrlArray indexOfObject:url]+type(M3U8-"",MP4-".mp4",Unknown-"") | 
NSString|videoFileNameAtIndex: | public | 根据url索引生成视频文件名 ，type(M3U8-"",MP4-".mp4",Unknown-"") 
NSString|filePathForURLAtIndex: | private | 无调用，废弃代码 | 可以删除
BOOL|isVideoOfUrlDownloaded: | private | 判断本视频的某个url是否已下载完成 |
NSString|localM3U8FilePath| public | 生成本地M3U8文件地址 | 
void|checkExistFilByLocalUrl:complete:|public|检查文件是否都存在 计算文件大小,block返回检查信息| 可做优化,封装到共享工具类中
NSArray|getTotalSegmentStreamList:|public|返回多段源的多个下载地址对应的所有本地文件路径 |

 




